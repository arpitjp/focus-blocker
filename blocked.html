<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocked - Focus Mode</title>
</head>
<body>
  <script src="blocked-ui.js"></script>
  <script>
    // Inject shared CSS
    const style = document.createElement('style');
    style.textContent = BlockedUI.css;
    document.head.appendChild(style);

    // Get blocked site from URL params
    const params = new URLSearchParams(window.location.search);
    const site = params.get('site') || params.get('url') || 'Website blocked';

    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'focus-blocked-overlay';
    overlay.innerHTML = BlockedUI.html(BlockedUI.escapeHtml(site), 'icon128.png');
    document.body.appendChild(overlay);

    // Timer state
    let timerInterval = null;
    let storageListener = null;
    let currentEndTime = null;

    function updateTimerDisplay() {
      const timerValue = document.getElementById('focus-blocked-timer-value');
      if (!timerValue) return;
      
      if (!currentEndTime) {
        timerValue.textContent = 'âˆž';
        return;
      }
      
      const remaining = Math.max(0, Math.floor((currentEndTime - Date.now()) / 1000));
      timerValue.textContent = remaining > 0 ? BlockedUI.formatTime(remaining) : 'Done!';
    }

    // Storage change listener
    storageListener = (changes, areaName) => {
      if (areaName !== 'sync' && areaName !== 'local') return;
      
      if (changes.blockingEnabled?.newValue === false) {
        cleanup();
        window.history.back();
        return;
      }
      
      if (changes.blockingEndTime !== undefined) {
        currentEndTime = changes.blockingEndTime.newValue;
        updateTimerDisplay();
      }
    };

    async function initialize() {
      try {
        const result = await chrome.storage.sync.get(['blockingEnabled', 'blockingEndTime']);
        
        if (!result.blockingEnabled) {
          window.history.back();
          return;
        }
        
        currentEndTime = result.blockingEndTime || null;
        updateTimerDisplay();
        
        timerInterval = setInterval(updateTimerDisplay, 1000);
        chrome.storage.onChanged.addListener(storageListener);
      } catch (e) {
        // Storage read failed
      }
    }

    function cleanup() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      if (storageListener) {
        chrome.storage.onChanged.removeListener(storageListener);
        storageListener = null;
      }
    }

    window.addEventListener('beforeunload', cleanup);

    // Handle branding click
    document.getElementById('focus-blocked-branding')?.addEventListener('click', (e) => {
      e.preventDefault();
      chrome.tabs.create({ url: chrome.runtime.getURL('popup.html') }).catch(() => {});
    });

    initialize();
  </script>
</body>
</html>
